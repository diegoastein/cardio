<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardiología Pediátrica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        /* Custom scrollbar for dropdowns */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, Component } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Heart, Activity, FileText, Search, Plus, Download, Trash2, Edit, Share2, 
            X, Calendar, ClipboardList, ChevronDown, Wifi, WifiOff, RefreshCw, 
            Loader2, AlertTriangle, Settings, CheckCircle, Info, Save, Database, Edit2, Check
        } from 'lucide-react';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ==========================================
        // CONFIGURACIÓN DE FIREBASE (EDITAR AQUÍ)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDI4kiZEbmTqsnrUEtbv8b1lTu81cP6-I8",
            authDomain: "cardio-5531c.firebaseapp.com",
            projectId: "cardio-5531c",
            storageBucket: "cardio-5531c.firebasestorage.app",
            messagingSenderId: "1879079234",
            appId: "1:1879079234:web:0586b362de0dbd048230db"
        };
        // ==========================================

        const DEFAULT_STUDIES = ['Ecocardiograma', 'Ecocardiograma Doppler', 'ECG'];

        let isConfigured = false;
        try {
            isConfigured = firebaseConfig && firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("TU_API_KEY_AQUI");
        } catch (e) {
            console.error("Error verificando config:", e);
        }

        let app, auth, db;
        if (isConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                if (!/already exists/.test(e.message)) console.error("Error iniciando Firebase:", e);
            }
        }

        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return React.createElement("div", { className: "min-h-screen flex items-center justify-center bg-gray-100 p-4" },
                        React.createElement("div", { className: "bg-white p-8 rounded-xl shadow-lg max-w-lg w-full text-center" },
                            React.createElement("h2", { className: "text-2xl font-bold text-red-600 mb-2" }, "Algo salió mal"),
                            React.createElement("p", { className: "text-sm text-gray-600 mb-4" }, this.state.error && this.state.error.toString()),
                            React.createElement("button", { 
                                onClick: () => { localStorage.clear(); window.location.reload(); },
                                className: "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                            }, "Reiniciar App")
                        )
                    );
                }
                return this.props.children;
            }
        }

        const Card = ({ children, className = "" }) => React.createElement("div", { className: `bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden ${className}` }, children);
        
        const Button = ({ children, onClick, variant = "primary", className = "", type = "button", disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50";
            const variants = {
                primary: "bg-teal-600 text-white hover:bg-teal-700 active:scale-95",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200 active:scale-95",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 active:scale-95",
                outline: "border border-gray-300 text-gray-700 hover:bg-gray-50",
                ghost: "text-gray-500 hover:bg-gray-100"
            };
            return React.createElement("button", { type, onClick, disabled, className: `${baseStyle} ${variants[variant]} ${className}` }, children);
        };

        const Toast = ({ message, type = 'success', onClose }) => {
            const bgClass = type === 'error' ? 'bg-red-600' : 'bg-teal-600';
            useEffect(() => { const timer = setTimeout(onClose, 2000); return () => clearTimeout(timer); }, [onClose]);
            return React.createElement("div", { className: `fixed top-4 right-4 ${bgClass} text-white px-6 py-4 rounded-lg shadow-xl z-50 flex items-center gap-3 toast-enter z-50` },
                React.createElement(type === 'error' ? AlertTriangle : CheckCircle, { size: 24 }),
                React.createElement("span", { className: "font-medium" }, message),
                React.createElement("button", { onClick: onClose, className: "ml-2 hover:bg-white/20 rounded-full p-1 transition-colors" }, React.createElement(X, { size: 18 }))
            );
        };

        const ConfigScreen = () => (
            React.createElement("div", { className: "min-h-screen bg-gray-50 flex items-center justify-center p-4" },
                React.createElement(Card, { className: "max-w-lg w-full p-8 text-center" },
                    React.createElement(Settings, { size: 32, className: "text-blue-600 mx-auto mb-4" }),
                    React.createElement("h2", { className: "text-2xl font-bold text-gray-900 mb-2" }, "Configuración Requerida"),
                    React.createElement("p", { className: "text-gray-600 mb-6" }, "Edita el archivo index.html con tus datos de Firebase."),
                    React.createElement("a", { href: "https://console.firebase.google.com/", target: "_blank", className: "inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700" }, "Ir a Firebase Console")
                )
            )
        );

        function CardioApp() {
            if (!isConfigured) return React.createElement(ConfigScreen);

            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('registro');
            
            const [patients, setPatients] = useState([]);
            const [diagnosesOptions, setDiagnosesOptions] = useState(['CIA', 'CIV', 'DAP', 'Insuficiencia Cardíaca', 'Estenosis Aórtica', 'Miocardiopatía']);
            const [studiesOptions, setStudiesOptions] = useState(DEFAULT_STUDIES);
            
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [isSyncing, setIsSyncing] = useState(false);
            const [pendingSyncs, setPendingSyncs] = useState([]);
            const [syncError, setSyncError] = useState(null); 
            
            const [notification, setNotification] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const initialFormState = { 
                id: null, 
                fecha: new Date().toISOString().split('T')[0], 
                nombre: '', 
                edad: '', 
                edadUnidad: 'Años', 
                estudios: [], 
                tipoPaciente: 'Ambulatorio', 
                diagnosticos: [], 
                notas: '' 
            };
            const [formData, setFormData] = useState(initialFormState);
            const [isEditing, setIsEditing] = useState(false);
            
            // Estados para el buscador de Diagnósticos
            const [diagSearch, setDiagSearch] = useState('');
            const [isDiagDropdownOpen, setIsDiagDropdownOpen] = useState(false);
            const [newStudy, setNewStudy] = useState('');

            const [searchTerm, setSearchTerm] = useState('');
            const [dateFilterStart, setDateFilterStart] = useState('');
            const [dateFilterEnd, setDateFilterEnd] = useState('');
            const [statsMonth, setStatsMonth] = useState(new Date().toISOString().slice(0, 7));

            const showToast = (msg, type = 'success') => setNotification({ message: msg, type });

            // 1. Carga Inicial
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                const safeLoad = (key, setter, fallback) => {
                    try {
                        const saved = localStorage.getItem(key);
                        if (saved) {
                            const parsed = JSON.parse(saved);
                            if (Array.isArray(parsed)) setter(parsed);
                        }
                    } catch (e) { console.error(`Error cargando ${key}`, e); }
                };

                safeLoad('cardio_patients', setPatients, []);
                safeLoad('cardio_diagnoses', setDiagnosesOptions, []);
                safeLoad('cardio_studies', setStudiesOptions, DEFAULT_STUDIES);
                
                try {
                    const savedQueue = localStorage.getItem('cardio_sync_queue');
                    if (savedQueue) setPendingSyncs(JSON.parse(savedQueue));
                } catch(e) {}

                if (auth) {
                    signInAnonymously(auth).catch(e => console.error("Auth Error:", e));
                    const unsub = onAuthStateChanged(auth, setUser);
                    return () => { window.removeEventListener('online', handleOnline); window.removeEventListener('offline', handleOffline); unsub(); };
                }
            }, []);

            // 2. Persistencia Local
            useEffect(() => { localStorage.setItem('cardio_patients', JSON.stringify(patients)); }, [patients]);
            useEffect(() => { localStorage.setItem('cardio_diagnoses', JSON.stringify(diagnosesOptions)); }, [diagnosesOptions]);
            useEffect(() => { localStorage.setItem('cardio_studies', JSON.stringify(studiesOptions)); }, [studiesOptions]);
            useEffect(() => { localStorage.setItem('cardio_sync_queue', JSON.stringify(pendingSyncs)); }, [pendingSyncs]);

            // 3. Sincronización
            useEffect(() => {
                if (!user || !db) return;
                const rootCollection = 'data_compartida';
                const workspaceDoc = 'cardiologia';
                
                const patientsRef = collection(db, rootCollection, workspaceDoc, 'pacientes');
                const unsubPatients = onSnapshot(patientsRef, (snap) => {
                    if (pendingSyncs.length === 0) setPatients(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, err => { if (err.code === 'permission-denied') setSyncError("Permiso denegado."); });

                const settingsRef = doc(db, rootCollection, workspaceDoc, 'configuracion', 'general');
                const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.diagnosticos && Array.isArray(data.diagnosticos)) setDiagnosesOptions(data.diagnosticos);
                        if (data.estudios && Array.isArray(data.estudios)) setStudiesOptions(data.estudios);
                    }
                }, err => console.log("Config offline"));

                return () => { unsubPatients(); unsubSettings(); };
            }, [user, pendingSyncs.length]);

            // 4. Cola Sync
            useEffect(() => {
                const process = async () => {
                    if (!isOnline || !user || pendingSyncs.length === 0 || isSyncing) return;
                    setIsSyncing(true);
                    setSyncError(null); 
                    const item = pendingSyncs[0];
                    const rootCollection = 'data_compartida';
                    const workspaceDoc = 'cardiologia';
                    try {
                        if (item.type === 'save_patient') await setDoc(doc(db, rootCollection, workspaceDoc, 'pacientes', item.data.id), item.data);
                        else if (item.type === 'delete_patient') await deleteDoc(doc(db, rootCollection, workspaceDoc, 'pacientes', item.id));
                        else if (item.type === 'save_settings') await setDoc(doc(db, rootCollection, workspaceDoc, 'configuracion', 'general'), { diagnosticos: item.diagnoses || diagnosesOptions, estudios: item.studies || studiesOptions }, { merge: true });
                        setPendingSyncs(p => p.slice(1));
                    } catch (e) { console.error("Sync", e); if (e.code === 'permission-denied') setSyncError("Permiso denegado"); } 
                    finally { setIsSyncing(false); }
                };
                const int = setInterval(process, 2000);
                return () => clearInterval(int);
            }, [isOnline, user, pendingSyncs, isSyncing]);

            const clearSyncQueue = () => { if(window.confirm("¿Descartar cambios pendientes?")) { setPendingSyncs([]); setSyncError(null); }};

            // --- SETTINGS LOGIC ---
            const saveSettings = (newDiagnoses, newStudies) => {
                if (newDiagnoses) setDiagnosesOptions(newDiagnoses);
                if (newStudies) setStudiesOptions(newStudies);
                setPendingSyncs(prev => [...prev, { type: 'save_settings', diagnoses: newDiagnoses, studies: newStudies }]);
            };

            // ESTUDIOS
            const addCustomStudy = () => {
                if (newStudy && !studiesOptions.includes(newStudy)) {
                    saveSettings(null, [...studiesOptions, newStudy]);
                    setFormData(prev => ({...prev, estudios: [...prev.estudios, newStudy]}));
                    setNewStudy('');
                }
            };
            const removeCustomStudy = (s) => {
                if (DEFAULT_STUDIES.includes(s)) return alert("No se puede borrar predeterminados.");
                if (confirm(`¿Borrar "${s}"?`)) saveSettings(null, studiesOptions.filter(x => x !== s));
            };
            const editCustomStudy = (s) => {
                if (DEFAULT_STUDIES.includes(s)) return;
                const corrected = prompt(`Editar "${s}" (vacío para borrar):`, s);
                if (corrected === null) return;
                if (corrected.trim() === '') return removeCustomStudy(s);
                if (corrected !== s) {
                    const updated = studiesOptions.map(x => x === s ? corrected : x);
                    if (formData.estudios.includes(s)) setFormData(p => ({...p, estudios: p.estudios.map(x => x===s?corrected:x)}));
                    saveSettings(null, updated);
                }
            };

            // DIAGNÓSTICOS (Nueva lógica)
            const addCustomDiagnosis = (diag) => {
                if (diag && !diagnosesOptions.includes(diag)) {
                    saveSettings([...diagnosesOptions, diag], null);
                    setFormData(prev => ({...prev, diagnosticos: [...prev.diagnosticos, diag]}));
                }
            };
            const removeCustomDiagnosis = (d) => {
                if (confirm(`¿Borrar diagnóstico "${d}" de la lista global?`)) {
                    saveSettings(diagnosesOptions.filter(x => x !== d), null);
                }
            };
            const editCustomDiagnosis = (d) => {
                const corrected = prompt(`Editar "${d}" (vacío para borrar):`, d);
                if (corrected === null) return;
                if (corrected.trim() === '') return removeCustomDiagnosis(d);
                if (corrected !== d) {
                    const updated = diagnosesOptions.map(x => x === d ? corrected : x);
                    if (formData.diagnosticos.includes(d)) setFormData(p => ({...p, diagnosticos: p.diagnosticos.map(x => x===d?corrected:x)}));
                    saveSettings(updated, null);
                }
            };

            // Ordenar diagnósticos alfabéticamente
            const sortedDiagnoses = useMemo(() => {
                return [...diagnosesOptions].sort((a, b) => a.localeCompare(b));
            }, [diagnosesOptions]);

            // Filtrar diagnósticos para el menú inteligente
            const filteredDiagnoses = useMemo(() => {
                const term = diagSearch.toLowerCase();
                return sortedDiagnoses.filter(d => d.toLowerCase().includes(term));
            }, [sortedDiagnoses, diagSearch]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (isSubmitting) return;
                if (!formData.nombre || formData.estudios.length === 0) { showToast("Falta nombre o estudio", 'error'); return; }
                
                setIsSubmitting(true);
                setTimeout(() => setIsSubmitting(false), 1000);

                const patient = isEditing ? formData : { ...formData, id: Date.now().toString() };
                setPatients(prev => {
                    const exists = prev.find(p => p.id === patient.id);
                    return exists ? prev.map(p => p.id === patient.id ? patient : p) : [patient, ...prev];
                });
                setPendingSyncs(prev => [...prev, { type: 'save_patient', data: patient }]);
                
                showToast("Guardado correctamente");
                setIsEditing(false);
                setFormData(initialFormState);
            };

            const toggleStudy = (s) => setFormData(p => ({...p, estudios: p.estudios.includes(s) ? p.estudios.filter(x => x!==s) : [...p.estudios, s]}));
            const handleDelete = (id) => {
                if (!window.confirm("¿Eliminar registro?")) return;
                try {
                    setPatients(prev => prev.filter(p => p.id !== id));
                    setPendingSyncs(prev => [...prev, { type: 'delete_patient', id }]);
                    showToast("Eliminado");
                } catch (e) { showToast("Error al borrar", 'error'); }
            };

            const filteredPatients = useMemo(() => {
                if (!searchTerm && !dateFilterStart && !dateFilterEnd) return [];
                const term = searchTerm.toLowerCase();
                return patients.filter(p => {
                    if (!p) return false; 
                    const matchesSearch = (p.nombre||'').toLowerCase().includes(term) || (p.diagnosticos||[]).some(d => d.toLowerCase().includes(term)) || (p.notas||'').toLowerCase().includes(term);
                    const matchesDate = (!dateFilterStart || p.fecha >= dateFilterStart) && (!dateFilterEnd || p.fecha <= dateFilterEnd);
                    return matchesSearch && matchesDate;
                });
            }, [patients, searchTerm, dateFilterStart, dateFilterEnd]);

            const stats = useMemo(() => {
                const monthData = patients.filter(p => p && p.fecha && p.fecha.startsWith(statsMonth));
                let ecgAmb=0, ecgInt=0, echoAmb=0, echoInt=0;
                monthData.forEach(p => {
                    const isAmb = p.tipoPaciente === 'Ambulatorio';
                    if (p.estudios.includes('ECG')) isAmb ? ecgAmb++ : ecgInt++;
                    if (p.estudios.some(s => s !== 'ECG')) isAmb ? echoAmb++ : echoInt++;
                });
                const [y, m] = statsMonth.split('-');
                const label = new Date(parseInt(y), parseInt(m)-1, 2).toLocaleString('es-AR', { month: 'long', year: 'numeric' });
                return { ecgTotal: ecgAmb+ecgInt, ecgAmb, ecgInt, echoTotal: echoAmb+echoInt, echoAmb, echoInt, total: monthData.length, label };
            }, [patients, statsMonth]);

            const handleSharePatient = (p) => {
                const edadStr = p.edadUnidad ? `${p.edad} ${p.edadUnidad}` : `${p.edad} Años`;
                const text = `Consulta Cardiológica\nPaciente: ${p.nombre}\nEdad: ${edadStr}\nFecha: ${new Date(p.fecha).toLocaleDateString('es-AR')}\nTipo: ${p.tipoPaciente}\nEstudios: ${p.estudios.join(', ')}\nDiagnóstico: ${p.diagnosticos.join(', ')}\nNotas: ${p.notas || '-'}`;
                shareText(text);
            };
            const handleShareStats = () => shareText(`Estadísticas ${stats.label}\n\nECG Total: ${stats.ecgTotal}\n - Ambulatorio: ${stats.ecgAmb}\n - Internado: ${stats.ecgInt}\n\nEcografías Total: ${stats.echoTotal}\n - Ambulatorio: ${stats.echoAmb}\n - Internado: ${stats.echoInt}\n\nTotal Pacientes: ${stats.total}`);
            const shareText = async (text) => {
                try { if (navigator.share) { await navigator.share({ title: 'Cardio', text }); return true; } await navigator.clipboard.writeText(text); showToast("Copiado"); } catch (e) {}
            };

            return React.createElement("div", { className: "min-h-screen bg-gray-50 pb-20", onClick: () => setIsDiagDropdownOpen(false) },
                notification && React.createElement(Toast, { message: notification.message, type: notification.type, onClose: () => setNotification(null) }),
                
                React.createElement("header", { className: "bg-white shadow-sm border-b sticky top-0 z-20 px-4 h-16 flex items-center justify-between max-w-6xl mx-auto" },
                    React.createElement("div", { className: "flex items-center gap-2 text-teal-700" },
                        React.createElement(Heart, { className: "fill-teal-600", size: 28 }),
                        React.createElement("h1", { className: "text-xl font-bold hidden sm:block" }, "Cardiología Pediátrica"),
                        React.createElement("h1", { className: "text-xl font-bold sm:hidden" }, "Cardio")
                    ),
                    React.createElement("div", { className: "flex items-center gap-2" },
                        React.createElement("div", { className: "flex items-center gap-1 text-xs bg-gray-100 px-2 py-1 rounded-full" },
                            isSyncing ? React.createElement(RefreshCw, { size: 16, className: "animate-spin text-blue-500" }) :
                            isOnline ? React.createElement(Wifi, { size: 16, className: "text-green-500" }) : React.createElement(WifiOff, { size: 16, className: "text-red-400" }),
                            pendingSyncs.length > 0 && React.createElement("span", { className: "bg-orange-500 text-white rounded-full w-4 h-4 flex items-center justify-center ml-1" }, pendingSyncs.length)
                        ),
                        [{id:'registro', icon: ClipboardList}, {id:'informes', icon: FileText}, {id:'estadisticas', icon: Activity}].map(t => 
                            React.createElement("button", { key: t.id, onClick: () => setActiveTab(t.id), className: `p-2 rounded-md ${activeTab === t.id ? 'bg-teal-50 text-teal-700' : 'text-gray-500'}` }, React.createElement(t.icon, { size: 22 }))
                        )
                    )
                ),

                syncError && React.createElement("div", { className: "bg-red-50 border-l-4 border-red-500 p-4 m-4 rounded flex flex-col gap-2 shadow-sm" },
                    React.createElement("div", { className: "flex justify-between items-start" },
                        React.createElement("div", null, React.createElement("p", { className: "font-bold flex items-center gap-2 text-red-700" }, React.createElement(AlertTriangle, { size: 18 }), "Error de Sincronización"), React.createElement("p", { className: "text-sm text-red-600" }, syncError)),
                        React.createElement("button", { onClick: clearSyncQueue, className: "text-xs bg-white border border-red-200 hover:bg-red-50 px-3 py-1.5 rounded text-red-700 whitespace-nowrap ml-4" }, "Descartar")
                    ),
                    syncError.includes("Permiso") && React.createElement("div", { className: "text-xs bg-red-100 p-3 rounded mt-1 border border-red-200" }, React.createElement("strong", { className: "block mb-1 text-red-800" }, "Copia esto en Reglas de Firebase:"), React.createElement("div", { className: "font-mono bg-gray-900 text-green-400 p-2 rounded overflow-x-auto select-all" }, "rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}"))
                ),

                React.createElement("main", { className: "max-w-6xl mx-auto px-4 py-6" },
                    activeTab === 'registro' && React.createElement("div", { className: "max-w-3xl mx-auto" },
                        React.createElement(Card, { className: "p-6" },
                            React.createElement("div", { className: "flex justify-between items-center mb-6" },
                                React.createElement("h2", { className: "text-xl font-bold text-teal-800 flex items-center gap-2" }, isEditing ? React.createElement(Edit) : React.createElement(Plus), isEditing ? 'Editar' : 'Nuevo Ingreso'),
                                isEditing && React.createElement(Button, { variant: "ghost", onClick: () => {setIsEditing(false); setFormData(initialFormState);} }, "Cancelar")
                            ),
                            React.createElement("form", { onSubmit: handleSubmit, className: "space-y-5" },
                                React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                                    React.createElement("div", null, React.createElement("label", { className: "block text-sm text-gray-700 font-medium mb-1" }, "Fecha"), React.createElement("input", { type: "date", required: true, className: "w-full p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none", value: formData.fecha, onChange: e => setFormData({...formData, fecha: e.target.value}) })),
                                    React.createElement("div", null, React.createElement("label", { className: "block text-sm text-gray-700 font-medium mb-1" }, "Nombre y Apellido"), React.createElement("input", { type: "text", required: true, placeholder: "Ej. Juan Pérez", className: "w-full p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none", value: formData.nombre, onChange: e => setFormData({...formData, nombre: e.target.value}) })),
                                    React.createElement("div", null, 
                                        React.createElement("label", { className: "block text-sm text-gray-700 font-medium mb-1" }, "Edad"), 
                                        React.createElement("div", { className: "flex gap-2" },
                                            React.createElement("input", { type: "number", required: true, className: "w-2/3 p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none", value: formData.edad, onChange: e => setFormData({...formData, edad: e.target.value}) }),
                                            React.createElement("div", { className: "relative w-1/3" },
                                                React.createElement("select", { className: "w-full p-2 border rounded-lg appearance-none bg-white focus:ring-2 focus:ring-teal-500 outline-none", value: formData.edadUnidad || 'Años', onChange: e => setFormData({...formData, edadUnidad: e.target.value}) },
                                                    React.createElement("option", { value: "Años" }, "Años"), React.createElement("option", { value: "Meses" }, "Meses"), React.createElement("option", { value: "Días" }, "Días")
                                                ),
                                                React.createElement(ChevronDown, { className: "absolute right-2 top-3 text-gray-400 pointer-events-none", size: 16 })
                                            )
                                        )
                                    ),
                                    React.createElement("div", null, React.createElement("label", { className: "block text-sm text-gray-700 font-medium mb-1" }, "Tipo"), React.createElement("div", { className: "flex gap-4 mt-2" }, ['Ambulatorio', 'Internado'].map(t => React.createElement("label", { key: t, className: "flex items-center gap-2 cursor-pointer" }, React.createElement("input", { type: "radio", name: "tipo", value: t, checked: formData.tipoPaciente === t, onChange: () => setFormData({...formData, tipoPaciente: t}), className: "text-teal-600 focus:ring-teal-500" }), React.createElement("span", null, t)))))
                                ),
                                
                                React.createElement("div", null, 
                                    React.createElement("label", { className: "block text-sm text-gray-700 font-medium mb-2" }, "Estudios"),
                                    React.createElement("div", { className: "flex flex-wrap gap-2 mb-3" }, studiesOptions.map(s => 
                                        React.createElement("div", { key: s, className: "relative group inline-flex items-center" }, 
                                            React.createElement("button", { type: "button", onClick: () => toggleStudy(s), className: `${DEFAULT_STUDIES.includes(s) ? 'px-3' : 'pr-16 pl-3'} py-1.5 rounded-full text-sm font-medium border transition-colors ${formData.estudios.includes(s) ? 'bg-teal-100 text-teal-800 border-teal-500' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}` }, s),
                                            !DEFAULT_STUDIES.includes(s) && React.createElement("button", { type: "button", onClick: (e) => { e.stopPropagation(); editCustomStudy(s); }, className: "absolute right-8 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity" }, React.createElement(Edit2, { size: 12 })),
                                            !DEFAULT_STUDIES.includes(s) && React.createElement("button", { type: "button", onClick: (e) => { e.stopPropagation(); removeCustomStudy(s); }, className: "absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" }, React.createElement(X, { size: 14 }))
                                        )
                                    )),
                                    React.createElement("div", { className: "flex gap-2" }, 
                                        React.createElement("input", { type: "text", placeholder: "Nuevo estudio...", className: "flex-1 p-2 border rounded-lg text-sm focus:ring-1 focus:ring-teal-500 outline-none", value: newStudy, onChange: e => setNewStudy(e.target.value) }), 
                                        React.createElement(Button, { variant: "secondary", onClick: addCustomStudy }, React.createElement(Plus, { size: 16 }), "Agregar")
                                    )
                                ),

                                // DIAGNÓSTICOS CON MENÚ INTELIGENTE
                                React.createElement("div", null, 
                                    React.createElement("label", { className: "block text-sm text-gray-700 font-medium mb-2" }, "Diagnósticos"), 
                                    React.createElement("div", { className: "relative mb-3", onClick: (e) => e.stopPropagation() }, 
                                        React.createElement("div", { className: "relative" },
                                            React.createElement("input", { 
                                                type: "text", 
                                                className: "w-full p-2 pr-10 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none", 
                                                placeholder: "Buscar o crear diagnóstico...",
                                                value: diagSearch,
                                                onChange: (e) => { setDiagSearch(e.target.value); setIsDiagDropdownOpen(true); },
                                                onFocus: () => setIsDiagDropdownOpen(true)
                                            }),
                                            React.createElement("div", { className: "absolute right-3 top-3 text-gray-400 pointer-events-none" }, diagSearch ? React.createElement(Search, {size: 16}) : React.createElement(ChevronDown, {size: 16}))
                                        ),
                                        // Dropdown Inteligente
                                        isDiagDropdownOpen && React.createElement("div", { className: "absolute z-30 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto scroller" },
                                            // Lista Filtrada
                                            filteredDiagnoses.map(d => 
                                                React.createElement("div", { key: d, className: "flex justify-between items-center px-3 py-2 hover:bg-gray-50 group" },
                                                    React.createElement("span", { 
                                                        className: `flex-1 cursor-pointer ${formData.diagnosticos.includes(d) ? 'text-teal-600 font-bold' : 'text-gray-700'}`,
                                                        onClick: () => {
                                                            if (!formData.diagnosticos.includes(d)) {
                                                                setFormData(p => ({...p, diagnosticos: [...p.diagnosticos, d]}));
                                                            }
                                                            setDiagSearch(''); 
                                                            // Mantener abierto para multi-selección o cerrar? "Selección debe ser múltiple" -> mejor mantener y limpiar search
                                                        }
                                                    }, d, formData.diagnosticos.includes(d) && React.createElement(Check, {size: 14, className: "inline ml-2"})),
                                                    // Acciones en el item
                                                    React.createElement("div", { className: "flex gap-1" },
                                                        React.createElement("button", { type: "button", onClick: (e) => {e.stopPropagation(); editCustomDiagnosis(d);}, className: "p-1 text-gray-400 hover:text-blue-500" }, React.createElement(Edit2, {size: 14})),
                                                        React.createElement("button", { type: "button", onClick: (e) => {e.stopPropagation(); removeCustomDiagnosis(d);}, className: "p-1 text-gray-400 hover:text-red-500" }, React.createElement(Trash2, {size: 14}))
                                                    )
                                                )
                                            ),
                                            // Opción Crear
                                            diagSearch && !filteredDiagnoses.includes(diagSearch) && (
                                                React.createElement("button", { 
                                                    type: "button",
                                                    className: "w-full text-left px-3 py-2 text-teal-600 hover:bg-teal-50 font-medium flex items-center gap-2 border-t",
                                                    onClick: () => { addCustomDiagnosis(diagSearch); setDiagSearch(''); }
                                                }, React.createElement(Plus, {size: 16}), `Crear "${diagSearch}"`)
                                            )
                                        )
                                    ),
                                    // Chips seleccionados
                                    React.createElement("div", { className: "flex flex-wrap gap-2 mb-2" }, formData.diagnosticos.map(d => React.createElement("span", { key: d, className: "bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm border border-blue-100 flex items-center gap-1" }, d, React.createElement("button", { type: "button", onClick: () => setFormData(p => ({...p, diagnosticos: p.diagnosticos.filter(x => x!==d)})) }, React.createElement(X, { size: 14 }))))),
                                ),

                                React.createElement("div", null, React.createElement("label", { className: "block text-sm text-gray-700 font-medium mb-1" }, "Notas"), React.createElement("textarea", { rows: 3, className: "w-full p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none", value: formData.notas, onChange: e => setFormData({...formData, notas: e.target.value}) })),
                                React.createElement(Button, { type: "submit", className: "w-full py-3", disabled: isSubmitting }, isSubmitting ? React.createElement(Loader2, { className: "animate-spin" }) : (isEditing ? "Guardar Cambios" : "Guardar Paciente"))
                            )
                        )
                    ),
                    activeTab === 'informes' && React.createElement("div", { className: "flex flex-col gap-4" },
                        React.createElement(Card, { className: "p-4 sticky top-0 z-10" },
                            React.createElement("div", { className: "flex flex-col md:flex-row gap-4 justify-between" },
                                React.createElement("div", { className: "relative flex-1" }, React.createElement(Search, { className: "absolute left-3 top-2.5 text-gray-400", size: 18 }), React.createElement("input", { type: "text", placeholder: "Buscar...", className: "w-full pl-10 p-2 border rounded-lg outline-none focus:ring-2 focus:ring-teal-500", value: searchTerm, onChange: e => setSearchTerm(e.target.value) })),
                                React.createElement("div", { className: "flex gap-2 items-center" }, React.createElement("input", { type: "date", className: "p-2 border rounded-lg text-sm", value: dateFilterStart, onChange: e => setDateFilterStart(e.target.value) }), React.createElement("span", { className: "text-gray-400" }, "→"), React.createElement("input", { type: "date", className: "p-2 border rounded-lg text-sm", value: dateFilterEnd, onChange: e => setDateFilterEnd(e.target.value) }))
                            ),
                            React.createElement(Button, { variant: "outline", className: "mt-4 w-full md:w-auto", onClick: () => {
                                const headers = ["ID,Fecha,Nombre,Edad,Tipo,Estudios,Diagnosticos,Notas"];
                                const rows = filtered.map(p => {
                                    const edadStr = p.edadUnidad ? `${p.edad} ${p.edadUnidad}` : `${p.edad} Años`;
                                    return `${p.id},${p.fecha},"${p.nombre}",${edadStr},${p.tipoPaciente},"${p.estudios.join('|')}","${p.diagnosticos.join('|')}","${p.notas}"`;
                                });
                                const link = document.createElement("a");
                                link.href = encodeURI("data:text/csv;charset=utf-8," + [headers, ...rows].join("\n"));
                                link.download = `registro_cardio_${new Date().toISOString().slice(0,10)}.csv`;
                                link.click();
                            }}, React.createElement(Download, { size: 18 }), "Exportar Resultados")
                        ),
                        React.createElement("div", { className: "bg-white rounded-xl shadow-sm border overflow-hidden" },
                            filtered.length === 0 ? React.createElement("div", { className: "p-12 text-center text-gray-500 flex flex-col items-center" }, React.createElement(Search, {size: 48, className: "mb-2 text-gray-300"}), "No se encontraron registros.") :
                            filtered.map(p => React.createElement("div", { key: p.id, className: "p-4 border-b hover:bg-gray-50 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4" },
                                React.createElement("div", { className: "flex-1" }, 
                                    React.createElement("div", { className: "flex items-baseline gap-2" }, 
                                        React.createElement("span", { className: "font-bold text-gray-900" }, p.nombre),
                                        React.createElement("span", { className: "text-xs text-gray-500" }, new Date(p.fecha).toLocaleDateString('es-AR'))
                                    ),
                                    React.createElement("div", { className: "text-sm text-gray-600" }, `${p.edad} ${p.edadUnidad || 'Años'} • ${p.tipoPaciente}`),
                                    React.createElement("div", { className: "mt-2 flex flex-wrap gap-1" }, p.estudios.map(s => React.createElement("span", { key: s, className: "text-xs bg-teal-50 text-teal-700 px-2 py-0.5 rounded border border-teal-100" }, s))),
                                    React.createElement("div", { className: "mt-1 flex flex-wrap gap-1" }, p.diagnosticos.map(d => React.createElement("span", { key: d, className: "text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded border border-blue-100" }, d)))
                                ),
                                React.createElement("div", { className: "flex gap-2 self-end sm:self-center" },
                                    React.createElement("button", { title: "Compartir Ficha", onClick: () => handleSharePatient(p), className: "p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors" }, React.createElement(Share2, { size: 20 })),
                                    React.createElement("button", { title: "Editar", onClick: () => { setFormData(p); setIsEditing(true); setActiveTab('registro'); }, className: "p-2 text-gray-600 hover:bg-gray-100 rounded transition-colors" }, React.createElement(Edit, { size: 20 })),
                                    React.createElement("button", { title: "Eliminar", onClick: () => handleDelete(p.id), className: "p-2 text-red-500 hover:bg-red-50 rounded transition-colors" }, React.createElement(Trash2, { size: 20 }))
                                )
                            ))
                        )
                    ),
                    activeTab === 'estadisticas' && React.createElement("div", { className: "space-y-6" },
                        React.createElement(Card, { className: "p-4 flex flex-col sm:flex-row justify-between items-center gap-4" },
                            React.createElement("div", { className: "flex items-center gap-3 w-full sm:w-auto" }, 
                                React.createElement(Calendar, { className: "text-teal-600" }), 
                                React.createElement("div", null, 
                                    React.createElement("span", { className: "text-xs text-gray-500 block" }, "Mes a analizar"),
                                    React.createElement("input", { type: "month", className: "bg-transparent font-medium outline-none text-gray-900", value: statsMonth, onChange: e => setStatsMonth(e.target.value) })
                                )
                            ),
                            React.createElement(Button, { variant: "outline", onClick: handleShareStats, className: "w-full sm:w-auto" }, React.createElement(Share2, { size: 18 }), "Compartir Resumen")
                        ),
                        React.createElement("div", { className: "grid md:grid-cols-2 gap-4" },
                            React.createElement(Card, { className: "p-6 bg-gradient-to-br from-teal-500 to-teal-700 text-white relative overflow-hidden" },
                                React.createElement("h3", { className: "text-teal-100 font-medium mb-1" }, "Total ECGs"),
                                React.createElement("div", { className: "text-5xl font-bold mb-4" }, stats.ecgTotal),
                                React.createElement("div", { className: "grid grid-cols-2 text-sm bg-white/10 p-3 rounded-lg backdrop-blur-sm" }, 
                                    React.createElement("div", null, React.createElement("span", { className: "block text-teal-200 text-xs" }, "Ambulatorio"), React.createElement("strong", { className: "text-lg" }, stats.ecgAmb)), 
                                    React.createElement("div", { className: "border-l border-white/20 pl-3" }, React.createElement("span", { className: "block text-teal-200 text-xs" }, "Internado"), React.createElement("strong", { className: "text-lg" }, stats.ecgInt))
                                )
                            ),
                            React.createElement(Card, { className: "p-6 bg-gradient-to-br from-blue-500 to-blue-700 text-white relative overflow-hidden" },
                                React.createElement("h3", { className: "text-blue-100 font-medium mb-1" }, "Total Ecografías"),
                                React.createElement("div", { className: "text-5xl font-bold mb-4" }, stats.echoTotal),
                                React.createElement("div", { className: "grid grid-cols-2 text-sm bg-white/10 p-3 rounded-lg backdrop-blur-sm" }, 
                                    React.createElement("div", null, React.createElement("span", { className: "block text-blue-200 text-xs" }, "Ambulatorio"), React.createElement("strong", { className: "text-lg" }, stats.echoAmb)), 
                                    React.createElement("div", { className: "border-l border-white/20 pl-3" }, React.createElement("span", { className: "block text-blue-200 text-xs" }, "Internado"), React.createElement("strong", { className: "text-lg" }, stats.echoInt))
                                )
                            )
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            React.createElement(ErrorBoundary, null, 
                React.createElement(CardioApp)
            )
        );
    </script>
</body>
</html>
